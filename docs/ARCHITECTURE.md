# goposter Mail - 系统架构

本文档深入探讨 goposter Mail 的技术架构、设计原则和核心组件，旨在为开发者提供一个清晰的系统内部工作原理视图。

---

## 1. 设计原则

goposter Mail 的架构设计遵循以下核心原则：

- **安全第一:** 在设计的每个层面都优先考虑安全性，从数据传输、存储到访问控制。
- **高性能:** 采用现代技术和并发模型，确保系统在高负载下依然能提供低延迟和高吞吐量。
- **模块化:** 将系统划分为多个逻辑清晰、功能独立的组件，便于维护、扩展和测试。
- **可伸缩性:** 架构设计支持未来向分布式系统的平滑演进，以应对不断增长的用户和数据量。

---

## 2. 技术栈

| 分类     | 技术/标准                               | 作用                                       |
| :------- | :-------------------------------------- | :----------------------------------------- |
| **后端**   | Go 1.19+                                | 核心业务逻辑，提供高性能的并发服务         |
| **前端**   | React 18, Vite, JavaScript              | 构建现代化、响应迅速的用户界面             |
| **数据库** | SQLite                                  | 存储核心业务数据，如用户、邮箱元数据等     |
| **缓存**   | Redis (生产环境推荐)                    | 缓存会话、热点数据，提升系统响应速度       |
| **协议**   | SMTP, IMAP, HTTPS                       | 标准邮件收发协议和安全的Web访问协议        |
| **安全**   | JWT, AES-256-GCM, TOTP, TLS 1.3, SPF, DKIM | 提供认证、加密、2FA、安全传输和邮件反伪造 |

---

## 3. 项目结构

项目采用扁平化的 Go 工作区结构，所有后端源码位于根目录，并编译为单个二进制文件。前端代码则独立存放于 `frontend` 目录。

```
/
├── go.mod            # Go 模块依赖
├── main.go           # 主程序入口、HTTP/API 服务器、WebSocket
├── auth.go           # 认证逻辑 (登录, JWT, 2FA)
├── database.go       # 数据库操作 (SQLite)
├── encryption.go     # 邮件内容的端到端加密 (AES-256-GCM)
├── smtp_relay.go     # SMTP 协议实现 (接收邮件)
├── smtp_sender.go    # SMTP 邮件发送逻辑
├── imap.go           # IMAP 协议实现
├── email_parser.go   # 邮件内容和头解析
├── async_sender.go   # 异步邮件发送队列
├── queue_system.go   # 内存消息队列实现
├── ...               # 其他核心 Go 源文件
├── frontend/         # React 前端应用
│   ├── src/
│   │   ├── components/ # React 组件
│   │   └── utils/      # API 调用和认证逻辑
│   └── dist/         # 前端构建产物
├── data/             # 运行时数据 (数据库, 加密后的邮件)
├── docs/             # 项目详细文档
└── test/             # 性能和压力测试脚本
```

---

## 4. 核心组件详解

### **4.1 Web & API 服务器 (`main.go`)**

- **角色:** 项目的入口点，负责初始化所有服务并启动 HTTP 服务器。
- **功能:**
  - **HTTP/S 监听:** 监听 Web 端口，处理所有 API 请求和静态资源服务。
  - **路由管理:** 定义所有 API 端点（如 `/api/login`, `/api/emails` 等）并将其分派到相应的处理函数。
  - **中间件:** 实现请求日志、CORS（跨域资源共享）策略和 JWT 认证中间件，用于保护需要授权的端点。
  - **WebSocket 服务:** 管理 `/ws` 端点，处理实时通信连接。

### **4.2 认证与安全模块 (`auth.go`, `jwt.go`, `encryption.go`)**

- **`auth.go`:** 处理用户登录、密码验证和 2FA 逻辑。
- **`jwt.go`:** 负责 JWT 的生成、解析和验证，包括访问令牌和刷新令牌的管理。
- **`encryption.go`:** 实现邮件内容的 AES-256-GCM 加密和解密。这是实现端到端加密（E2EE）的核心。

### **4.3 邮件协议服务器 (`smtp_relay.go`, `imap.go`)**

- **`smtp_relay.go`:** 实现了一个完整的 SMTP 服务器，用于接收来自其他邮件服务器的邮件。它负责处理 SMTP 会话、解析命令，并将接收到的邮件存入处理队列。
- **`imap.go`:** 实现了一个 IMAP 服务器，允许用户通过桌面或移动邮件客户端（如 Outlook, Thunderbird）访问和管理他们的邮件。

### **4.4 异步处理系统 (`async_sender.go`, `queue_system.go`)**

- **`queue_system.go`:** 提供一个轻量级、高性能的内存消息队列。这是系统解耦和实现异步处理的关键。
- **`async_sender.go`:**
  - **入队:** 当用户通过 API 发送邮件或系统接收到外部邮件时，邮件任务被放入内存队列，API 或 SMTP 服务器可以立即响应，无需等待邮件发送完成。
  - **出队:** 一个或多个后台 Goroutine（工作者）从队列中取出邮件任务。
  - **发送:** 工作者负责执行实际的 SMTP 发送逻辑（DNS查询、连接目标服务器、发送邮件），并处理可能出现的重试。

![异步邮件处理流程图](https://i.imgur.com/your-diagram-url.png)  <!-- 占位符 -->
*图1: 异步邮件处理流程*

### **4.5 数据存储 (`database.go`, `storage.go`)**

- **`database.go`:** 封装了所有与 SQLite 数据库的交互。它使用连接池来高效地管理数据库连接。
- **`storage.go`:** 提供了一个更高层次的存储抽象，负责管理邮件的物理存储。当一封邮件被接收时，它会：
  1.  调用 `encryption.go` 加密邮件内容。
  2.  将加密后的邮件正文保存为文件。
  3.  将邮件的元数据（发件人、收件人、主题、存储路径等）存入 SQLite 数据库。

---

## 5. 数据流

### **接收邮件数据流**

1.  外部邮件服务器连接到本机的 **SMTP 服务器** (端口 25)。
2.  SMTP 服务器完成握手，接收邮件数据。
3.  邮件被传递给 **Email Parser** 进行解析。
4.  解析后的邮件被放入 **内存队列**。
5.  后台工作者从队列中取出邮件，调用 **Storage** 服务。
6.  Storage 服务加密邮件内容，将其存入文件系统，并将元数据写入 **SQLite 数据库**。
7.  通过 **WebSocket** 向在线的客户端推送新邮件通知。

### **发送邮件数据流**

1.  用户通过 **前端界面** 或邮件客户端发送邮件。
2.  请求到达 **API 服务器** (`/api/send`) 或 **SMTP 服务器**。
3.  邮件任务被放入 **异步发送队列**，API 立即返回成功响应。
4.  **Async Sender** 的后台工作者从队列中取出任务。
5.  工作者执行 DNS MX 记录查询，找到目标邮件服务器。
6.  与目标服务器建立 SMTP 连接，并发送邮件。
7.  发送成功的邮件被存入用户的“已发送”邮箱。
